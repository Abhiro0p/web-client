<div class="modal fade" id="modal-edit-indicator-features" role="dialog">
	<div class="modal-dialog modal-xl">
		<div class="modal-content">

			<div align="center">
				<div class="loading-overlay-admin-panel ng-hide" ng-show="loadingData">
							<span class="glyphicon glyphicon-refresh icon-spin"></span>
				</div>
			</div>


			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title">Features des Indikators <i><b>{{currentIndicatorDataset.indicatorName}}</b></i> fortf&uuml;hren</h4>
			</div>
			<div class="modal-body">

				<!-- {
						  "geoJsonString": "geoJsonString",
						  "periodOfValidity": {
						    "endDate": "2000-01-23",
						    "startDate": "2000-01-23"
						  }
						}
			 -->

			 <!-- MultiStep Form -->
			 <div class="row">
				<div class="col-md-12">
					<form class="multiStepForm form-group" id="indicatorEditFeaturesForm" role="form" data-toggle="validator" data-disable="true" style="margin-bottom: 0px;">
						<!-- progressbar -->
						<ul id="progressbar">
							<li style="width: 50%;" class="active">Feature &Uuml;bersicht</li>
							<li style="width: 50%;">R&auml;umlicher Datensatz</li>
						</ul>
						<!-- fieldsets -->
						<fieldset>
							<h2 class="fs-title">Feature &Uuml;bersicht</h2>
							<h3 class="fs-subtitle">Optionale Anzeige der Feature-Details</h3>

							<div class="row vertical-align">
								<div class="col-md-4 col-sm-4 col-xs-12">
									<div class="form-group">
										<label >Raumeinheit w&auml;hlen</label>
										<select ng-model="overviewTableTargetSpatialUnitMetadata" ng-options="spatialUnit as spatialUnit.spatialUnitLevel for spatialUnit in $ctrl.kommonitorDataExchangeServiceInstance.availableSpatialUnits | filter:filterOverviewTargetSpatialUnits()"
												class="form-control" required>
												<option disabled selected value> -- Ziel-Raumebene w&auml;hlen -- </option>
											</select>

										<!-- <div class="help-block"><p></p></div> -->
										<div class="help-block with-errors"></div>
									</div>
								</div>
								<div class="col-md-4 col-sm-4 col-xs-12">
									<div class="form-group">
										<label >Datenbank-Features holen</label>
										<button class="btn btn-info" ng-click="refreshIndicatorEditFeaturesOverviewTable()"><i class="fas fa-sync-alt"></i>&nbsp;Zeige alle Features</button>
	   
										<div class="help-block"><p>Das Anzeigen aller Features des Indikators kann je nach Anzahl und Komplexität der Objekte einige Zeit in Anspruch nehmen</p></div>
										<div class="help-block with-errors"></div>
									</div>
								</div>
								<div class="col-md-4 col-sm-4 col-xs-12">
									<div class="form-group">
										<label >Datenbank-Features bereinigen</label>
										<button class="btn btn-danger" ng-click="clearAllIndicatorFeatures()"><i class="fas fa-trash"></i>&nbsp;Lösche Indikator-Features der selektierten Raumebene</button>
	   
										<div class="help-block"><p>Das Löschen aller Features des Indikators f&uuml;r die selektierte Raumebene ist unwiderruflich. Der Datensatz als solches (Metadaten) sowie die Indikatorendaten der sonstigen Raumebenen bleiben dabei bestehen.</p></div>
										<div class="help-block with-errors"></div>
									</div>
								</div>
					</div>
	   
					<div class="admin-table-wrapper" >
						<table id="indicatorFeatureTable" datatable="ng" dt-options="$ctrl.kommonitorDataExchangeServiceInstance.datatablesOptions" class="table table-bordered table-condensed table-striped" style="width:100%; overflow:auto; font-size: 11px;">
							<thead>
							<tr>
								<th>Id</th>
								<th>Name</th>
								<th>G&uuml;ltigkeitszeitraum</th>
								<th>Koordinatensystem</th>
								<th ng-repeat="header in remainingFeatureHeaders">{{header}}</th>
							</tr>
							</thead>
	   
							<tbody>
							<tr ng-repeat="indicatorFeature in indicatorFeaturesJSON">
								<td>{{getFeatureId(indicatorFeature)}}</td>
								<td>{{getFeatureName(indicatorFeature)}}</td>
								<td>
									<p ng-show="indicatorFeature.validEndDate">{{indicatorFeature.validStartDate | date:'yyyy-MM-dd'}} - {{indicatorFeature.validEndDate | date:'yyyy-MM-dd'}}</p>
									<p ng-show="! indicatorFeature.validEndDate">{{indicatorFeature.validStartDate | date:'yyyy-MM-dd'}} - heute </p>
								</td>
								<td>4326</td>
								<td ng-repeat="header in remainingFeatureHeaders" >{{indicatorFeature[header]}}</td>
							</tr>
	   
							</tbody>
	   
							<tfoot>
							<tr>
								<th>Id</th>
								<th>Name</th>
								<th>G&uuml;ltigkeitszeitraum</th>
								<th>Koordinatensystem</th>
								<th ng-repeat="header in remainingFeatureHeaders">{{header}}</th>
							</tr>
							</tfoot>
						</table>
	   
					</div>
	   
							
								<input type="button" name="next" class="next next_editFeaturesIndicator action-button" value="N&auml;chster Schritt"/>
						</fieldset>					

						<fieldset>
							<div style="position: absolute;">
								<button type="button" class="btn btn-info pull-left" ng-click="onImportIndicatorEditFeaturesMappingConfig()" title="Importieren der Mapping-Konfigurationen aus einer Datei"><i class="fas fa-file-import"></i>&nbsp;&nbsp;Mapping-Import</button>
								<input style="display:none;" class="pull-left" type="file" class="form-control" id="indicatorMappingConfigEditFeaturesImportFile" accept=".json,"></input>
								<button type="button" style="margin-left: 6px;" class="btn btn-info pull-left" ng-click="onExportIndicatorEditFeaturesMappingConfig()" title="Exportieren der Mapping-Konfigurationen in eine Datei"><i class="fas fa-file-export"></i>&nbsp;&nbsp;Mapping-Export</button>								
							</div>

							<h2 class="fs-title">Zeitreihen-Import</h2>
							<h3 class="fs-subtitle">Angaben &uuml;ber den Datensatz, aus dem die
								Indikatoren-Zeitreihen-Werte importiert werden</h3>
							<p><b><i>* = Pflichtfeld</i></b></p>

							<div class="row vertical-align">
								<div class="col-md-3 col-sm-6 col-xs-12">
									<div class="form-group">
										<label>Datensatz-Quellformat*</label>
										<select ng-model="converter"
											ng-options="converter as converter.simpleName for converter in $ctrl.kommonitorImporterHelperServiceInstance.availableConverters"
											class="form-control" required>
											<option disabled selected value> -- Quellformat w&auml;hlen -- </option>
										</select>
										<div class="help-block with-errors"></div>
									</div>
									<div ng-show="converter.schemas">

										<div class="form-group">
											<label>Schema*</label>
											<select ng-model="schema" ng-options="schema for schema in converter.schemas"
												ng-change="onChangeSchema(schema)" class="form-control" required>
												<option disabled selected value> -- Schema w&auml;hlen -- </option>
											</select>
											<div class="help-block with-errors"></div>
										</div>
									</div>

									<div ng-repeat="parameter in converter.parameters">

										<div class="form-group">
											<label>{{parameter.name}}*</label>
											<input type="text" id="converterParameter_indicatorEditFeatures_{{parameter.name}}" class="form-control"
												placeholder="{{parameter.name}}" required>
											<div class="help-block">
												<p>{{parameter.description}}</p>
											</div>
											<div ng-show="parameter.name === 'CRS'" class="help-block with-errors" style="color: red;">
												<p>CRS aufmerksam setzen. Falsche Angaben f&uuml;hren zur fehlerhaften Koordinaten der Features</p>
											</div>
											<div class="help-block with-errors"></div>
										</div>
									</div>

								</div>
								<div class="col-md-3 col-sm-6 col-xs-12">
									<div class="form-group">
										<div ng-show="!converter">
											<p>bitte zuerst das Quellformat w&auml;hlen</p>
										</div>
										<div ng-show="converter">
											<div class="form-group">
												<label>Datenquelltyp*</label>
												<select ng-model="datasourceType"
													ng-options="datasourceType as datasourceType.type for datasourceType in $ctrl.kommonitorImporterHelperServiceInstance.availableDatasourceTypes"
													class="form-control" required>
													<option disabled selected value> -- Quelltyp w&auml;hlen -- </option>
												</select>
												<div class="help-block with-errors"></div>
											</div>

											<div ng-show="datasourceType.type === 'FILE'">
												<label>Datei*</label>
												<input type="file" class="form-control" id="indicatorDataSourceInput_editFeatures" required></input>
											</div>
											<div ng-show="! (datasourceType.type === 'FILE')">
												<div ng-repeat="parameter in datasourceType.parameters">
													<div class="form-group">
														<label>{{parameter.name}}*</label>
														<textarea rows="1" id="datasourceTypeParameter_indicatorEditFeatures_{{parameter.name}}"
															class="form-control" placeholder="{{parameter.name}}" required></textarea>
														<div class="help-block">
															<p>{{parameter.description}}</p>
														</div>
														<div class="help-block with-errors"></div>
													</div>
												</div>
											</div>
										</div>
										<!-- <div class="help-block"><p>Features m&uuml;ssen Informationen &uuml;ber eindutige ID und eindeutigen Namen in Attribut namens <code>ID</code> und <code>NAME</code> enthalten, um in KomMonitor verarbeitet werden zu k&ouml;nnen.</p></div> -->

										<div class="help-block with-errors"></div>
										<div ng-show="indicatorDataSourceInputInvalid" style="color: red;">
											<p>Eingabe ung&uuml;ltig. Grund: {{indicatorDataSourceInputInvalidReason}}</p>
										</div>
									</div>
								</div>
								<div class="col-md-3 col-sm-6 col-xs-12">
									<div class="form-group">
										<label>ID Attributname der Raumeinheiten-Features*</label>
										<input type="text" class="form-control" ng-model="spatialUnitRefKeyProperty" required></input>
										<div class="help-block">
											<p>Name des Attributs, welches den eindeutigen Identifier des Features enth&auml;lt. Dieser muss identisch sein mit den Feature-IDs der selektierten Raumebene</p>
										</div>
										<div class="help-block with-errors"></div>
										<div ng-show="idPropertyNotFound" style="color: red;">
											<p>Eingabe ung&uuml;ltig. Angegebenes Attribut nicht gefunden oder enth&auml;lt NULL-Werte.</p>
										</div>
									</div>
								</div>
								<div class="col-md-3 col-sm-6 col-xs-12">
									<div class="form-group">
										<label>Ziel-Raumebene*</label>
										
										<select ng-model="targetSpatialUnitMetadata" ng-options="spatialUnit as spatialUnit.spatialUnitLevel for spatialUnit in $ctrl.kommonitorDataExchangeServiceInstance.availableSpatialUnits"
												class="form-control" required>
												<option disabled selected value> -- Ziel-Raumebene w&auml;hlen -- </option>
											</select>
											<div class="help-block with-errors"></div>

									</div>
								</div>							
							</div>

							<hr>
							
							<br/>

							<h4>Zeitreihen-Mapping</h4>
							<p>Angabe des Attribut-Mappings f&uuml;r jeden zu importierenden Zeitschnitt. Jedes Mapping umfasst dabei das Attribut, in dem die Indikatoren-Werte hinterlegt sind 
								sowie entweder einen direkt definierten Zeitstempel oder ein Attribut, welches den Zeitstempel gem&auml;&szlig; ISO8601 enth&auml;lt</p>

							<div class="row vertical-align">
								<div class="col-md-4 col-sm-6 col-xs-12">
									<div class="form-group">
										<label>Attributname der Indikatorenwerte*</label>
										<input type="text" class="form-control input-sm" placeholder="Attributname für Indikatorenwerte" ng-model="tmpTimeseriesMapping_indicatorValuesPropertyName">
										<div class="help-block with-errors"></div>
									</div>
								</div>
								<div class="col-md-4 col-sm-6 col-xs-12">												
									<label></label>
									<label class="switch">
										<input type="checkbox" value="useTimeseriesAsProperty" ng-model="useTimeseriesAsProperty" ng-change="onChangeUseTimeseriesAsProperty()">
										<span class="switchslider round"></span>
									</label>	
								
									<div class="help-block">
										<p>Angabe, ob der Zeitstempel aus einem Attribut entnommen werden soll</p>
									</div>
								</div>
								<div ng-show="useTimeseriesAsProperty" class="col-md-4 col-sm-6 col-xs-12">												
									<div class="form-group">
										<label>Attributname des Zeitstempels</label>
										<input type="text" class="form-control input-sm" placeholder="Attributname für Zeitstempel" ng-model="tmpTimeseriesMapping_timestampPropertyName">
										<div class="help-block with-errors"></div>
									</div>
								</div>
								<div ng-show="! useTimeseriesAsProperty" class="col-md-4 col-sm-6 col-xs-12">
									<div class="form-group">
										<label>Zeitstempel (direkte Angabe)</label>
										<div class="input-group date">
											<div class="input-group-addon">
												<i class="far fa-calendar-alt"></i>
											</div>
											<input type="text" ng-model="tmpTimeseriesMapping_directTimestamp" placeholder="YYYY-MM-DD"
												class="form-control pull-right" id="indicatorEditFeaturesDirectTimestampDatepicker">
										</div>
									</div>
								</div>
							</div>

							<div class="row vertical-align">
								<div class="col-md-3 col-sm-6 col-xs-12">
									<div class="form-group">
										<button class="btn btn-success btn-sm" ng-disabled="!tmpTimeseriesMapping_indicatorValuesPropertyName || (! tmpTimeseriesMapping_timestampPropertyName && !tmpTimeseriesMapping_directTimestamp)" ng-click="onEditFeaturesOrUpdateTimeseriesMapping()">Hinzuf&uuml;gen/Editieren</button>
										<div class="help-block with-errors"></div>
									</div>
								</div>
							</div>

							<br/>
							<br/>

							<!-- Table to display currently specified references -->
							<div class="row vertical-align">
								<div class="col-md-12 col-sm-12 col-xs-12">
									<label>&Uuml;bersicht der definierten Indikatoren-Zeitreihen-Mappings</label>
									<table class="table table-condensed">
										<thead>
											<tr>
												<th>Editierfunktionen</th>
												<th>Attributname der Indikatorenwerte</th>
												<th>Attributname des Zeitstempels</th>
												<th>Zeitstempel (direkte Angabe)</th>
											</tr>
										</thead>
										<tbody>
											<tr ng-repeat="timeseriesMappingEntry in timeseriesMappings_adminView">
												<td>
													<div class="btn-group btn-group-sm">
														<button class="btn btn-warning btn-sm" type="button" ng-click="onClickEditTimeseriesMapping(timeseriesMappingEntry)"
															title="Referenz editieren"><i class="fas fa-pencil-alt"></i></button>
														<button class="btn btn-danger btn-sm" type="button" ng-click="onClickDeleteTimeseriesMapping(timeseriesMappingEntry)"
															title="Referenz l&ouml;schen"><i class="fas fa-trash"></i></button>
													</div>
												</td>
												<td>{{timeseriesMappingEntry.indicatorValuesPropertyName}}</td>
												<td>{{timeseriesMappingEntry.timestampPropertyName}}</td>
												<td>{{timeseriesMappingEntry.timestampDirect}}</td>
											</tr>
										</tbody>
									</table>
								</div>
							</div>

							<input type="button" name="previous" class="previous previous_editFeaturesIndicator action-button-previous" value="Voriger Schritt"/>

						</fieldset>
					</form>
				</div>
			</div>

			 <form role="form" class="form-group" data-toggle="validator" style="margin-bottom: 0px;">

			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default pull-left" data-dismiss="modal">Schlie&szlig;en</button>
					<button type="button" class="btn btn-success" ng-disabled=" !converter || !datasourceType || !targetSpatialUnitMetadata || !spatialUnitRefKeyProperty" ng-click="editIndicatorFeatures()">Features fortf&uuml;hren</button>
					<button type="button" class="btn btn-danger" ng-click="resetIndicatorEditFeaturesForm()">Zur&uuml;cksetzen</button>
			</div>

			<div id="indicatorEditFeaturesSuccessAlert" style="position: absolute; bottom: 0px; width: 100%;" hidden class="alert alert-success alert-dismissable">
                <button type="button" class="close" ng-click="hideSuccessAlert()" aria-hidden="true">&times;</button>
                <h4><i class="icon fa fa-check"></i>Features erfolgreich fortgef&uuml;hrt</h4>
				<p>Fortf&uuml;hren der Features des Indikators mit Namen {{successMessagePart}} war erfolgreich.
					<div ng-show="importedFeatures && importedFeatures.length > 0">
						{{importedFeatures.length}} Features wurden dabei importiert.
					</div>
				</p>
      </div>

			<div id="indicatorEditFeaturesErrorAlert" style="position: absolute; bottom: 0px; width: 100%;" hidden class="alert alert-danger alert-dismissable">
                <button type="button" class="close" ng-click="hideErrorAlert()" aria-hidden="true">&times;</button>
                <h4><i class="icon fa fa-ban"></i>Features fortf&uuml;hren gescheitert</h4>
                Beim Fortf&uuml;hren der Features ist ein Fehler aufgetreten. Fehlermeldung:
				<br/>
				<pre style="overflow:auto; max-height:500px;" ng-bind-html="errorMessagePart"></pre>
				<br/>
				<br/>

				<div ng-show="importerErrors">
					<p>Bei den {{importerErrors.length}} Features mit folgenden IDs scheitert der Import:</p>
					<pre style="overflow:auto; max-height:500px;">
						<ul>
							<li ng-repeat="error in importerErrors">{{error}}</li>
						</ul>
					</pre>	
					<p>Bitte beheben Sie die angezeigten Fehler im Datensatz und wiederholen den Prozess.</p>
				</div>
	  </div>
	  
	  <div id="indicatorEditFeaturesMappingConfigImportErrorAlert" style="position: absolute; bottom: 0px; width: 100%;" hidden class="alert alert-danger alert-dismissable">
		<button type="button" class="close" ng-click="hideMappingConfigErrorAlert()" aria-hidden="true">&times;</button>
		<h4><i class="icon fa fa-ban"></i>Mapping-Konfiguration Import gescheitert</h4>
		Beim Import der Mapping-Konfiguration aus einer Datei ist ein Fehler aufgetreten. Fehlermeldung:
						<br/>
						<pre ng-bind-html="indicatorEditFeaturesMappingConfigImportError"></pre>								
						<br/>								
						<br/>
						<p>Bitte stellen Sie sicher, dass folgendes JSON-Format eingehalten wird:</p>
						<pre id="indicatorsEditFeaturesMappingConfigPre" style="overflow:auto; max-height:500px;"></pre>
	  </div>

		</div>
		<!-- /.modal-content -->
	</div>
	<!-- /.modal-dialog -->
</div>
<!-- /.modal -->
